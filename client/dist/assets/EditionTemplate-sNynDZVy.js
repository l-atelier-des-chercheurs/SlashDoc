import{M as v}from"./MediaPicker-BJlinVdy.js";import{n as h,C as A,M as F,_ as O}from"../build.js";import{M as T}from"./index-D86njK8L.js";import{m as j,H as x,d as f,V as B}from"./ViewContent-LyyRzhin.js";/* empty css               */import{P as R}from"./PublicationSettings-DIeHMtor.js";import"./PickExistingMediastackModal-ItfKHM_-.js";import"./DestinationCorpusSelector-CGRsgme7.js";import"./CorpusManager-Dn_qcZls.js";import"./KeywordsField-Ckq-W3DH.js";import"./TwoColumnLayout-DsthKvhd.js";import"./PositionPicker-CXwaVC6C.js";import"./SearchInput2-waoIV-0G.js";var E=Object.defineProperty,D=Object.defineProperties,L=Object.getOwnPropertyDescriptors,g=Object.getOwnPropertySymbols,C=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable,y=(i,t,e)=>t in i?E(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,I=(i,t)=>{for(var e in t||(t={}))C.call(t,e)&&y(i,e,t[e]);if(g)for(var e of g(t))k.call(t,e)&&y(i,e,t[e]);return i},N=(i,t)=>D(i,L(t)),q=(i,t)=>{var e={};for(var s in i)C.call(i,s)&&t.indexOf(s)<0&&(e[s]=i[s]);if(i!=null&&g)for(var s of g(i))t.indexOf(s)<0&&k.call(i,s)&&(e[s]=i[s]);return e};function S(i,t,e,s,a,n,o,r){var c=typeof i=="function"?i.options:i;t&&(c.render=t,c.staticRenderFns=e,c._compiled=!0);var _;if(a&&(_=a),_)if(c.functional){c._injectStyles=_;var l=c.render;c.render=function(p,m){return _.call(m),l(p,m)}}else{var d=c.beforeCreate;c.beforeCreate=d?[].concat(d,_):[_]}return{exports:i,options:c}}const H={name:"splitpanes",props:{horizontal:{type:Boolean},pushOtherPanes:{type:Boolean,default:!0},dblClickSplitter:{type:Boolean,default:!0},rtl:{type:Boolean,default:!1},firstSplitter:{type:Boolean}},provide(){return{requestUpdate:this.requestUpdate,onPaneAdd:this.onPaneAdd,onPaneRemove:this.onPaneRemove,onPaneClick:this.onPaneClick}},data:()=>({container:null,ready:!1,panes:[],touch:{mouseDown:!1,dragging:!1,activeSplitter:null},splitterTaps:{splitter:null,timeoutId:null}}),computed:{panesCount(){return this.panes.length},indexedPanes(){return this.panes.reduce((i,t)=>(i[t.id]=t)&&i,{})}},methods:{updatePaneComponents(){this.panes.forEach(i=>{i.update&&i.update({[this.horizontal?"height":"width"]:`${this.indexedPanes[i.id].size}%`})})},bindEvents(){document.addEventListener("mousemove",this.onMouseMove,{passive:!1}),document.addEventListener("mouseup",this.onMouseUp),"ontouchstart"in window&&(document.addEventListener("touchmove",this.onMouseMove,{passive:!1}),document.addEventListener("touchend",this.onMouseUp))},unbindEvents(){document.removeEventListener("mousemove",this.onMouseMove,{passive:!1}),document.removeEventListener("mouseup",this.onMouseUp),"ontouchstart"in window&&(document.removeEventListener("touchmove",this.onMouseMove,{passive:!1}),document.removeEventListener("touchend",this.onMouseUp))},onMouseDown(i,t){this.bindEvents(),this.touch.mouseDown=!0,this.touch.activeSplitter=t},onMouseMove(i){this.touch.mouseDown&&(i.preventDefault(),this.touch.dragging=!0,this.calculatePanesSize(this.getCurrentMouseDrag(i)),this.$emit("resize",this.panes.map(t=>({min:t.min,max:t.max,size:t.size}))))},onMouseUp(){this.touch.dragging&&this.$emit("resized",this.panes.map(i=>({min:i.min,max:i.max,size:i.size}))),this.touch.mouseDown=!1,setTimeout(()=>{this.touch.dragging=!1,this.unbindEvents()},100)},onSplitterClick(i,t){"ontouchstart"in window&&(i.preventDefault(),this.dblClickSplitter&&(this.splitterTaps.splitter===t?(clearTimeout(this.splitterTaps.timeoutId),this.splitterTaps.timeoutId=null,this.onSplitterDblClick(i,t),this.splitterTaps.splitter=null):(this.splitterTaps.splitter=t,this.splitterTaps.timeoutId=setTimeout(()=>{this.splitterTaps.splitter=null},500)))),this.touch.dragging||this.$emit("splitter-click",this.panes[t])},onSplitterDblClick(i,t){let e=0;this.panes=this.panes.map((s,a)=>(s.size=a===t?s.max:s.min,a!==t&&(e+=s.min),s)),this.panes[t].size-=e,this.$emit("pane-maximize",this.panes[t])},onPaneClick(i,t){this.$emit("pane-click",this.indexedPanes[t])},getCurrentMouseDrag(i){const t=this.container.getBoundingClientRect(),{clientX:e,clientY:s}="ontouchstart"in window&&i.touches?i.touches[0]:i;return{x:e-t.left,y:s-t.top}},getCurrentDragPercentage(i){i=i[this.horizontal?"y":"x"];const t=this.container[this.horizontal?"clientHeight":"clientWidth"];return this.rtl&&!this.horizontal&&(i=t-i),i*100/t},calculatePanesSize(i){const t=this.touch.activeSplitter;let e={prevPanesSize:this.sumPrevPanesSize(t),nextPanesSize:this.sumNextPanesSize(t),prevReachedMinPanes:0,nextReachedMinPanes:0};const s=0+(this.pushOtherPanes?0:e.prevPanesSize),a=100-(this.pushOtherPanes?0:e.nextPanesSize),n=Math.max(Math.min(this.getCurrentDragPercentage(i),a),s);let o=[t,t+1],r=this.panes[o[0]]||null,c=this.panes[o[1]]||null;const _=r.max<100&&n>=r.max+e.prevPanesSize,l=c.max<100&&n<=100-(c.max+this.sumNextPanesSize(t+1));if(_||l){_?(r.size=r.max,c.size=Math.max(100-r.max-e.prevPanesSize-e.nextPanesSize,0)):(r.size=Math.max(100-c.max-e.prevPanesSize-this.sumNextPanesSize(t+1),0),c.size=c.max);return}if(this.pushOtherPanes){const d=this.doPushOtherPanes(e,n);if(!d)return;({sums:e,panesToResize:o}=d),r=this.panes[o[0]]||null,c=this.panes[o[1]]||null}r!==null&&(r.size=Math.min(Math.max(n-e.prevPanesSize-e.prevReachedMinPanes,r.min),r.max)),c!==null&&(c.size=Math.min(Math.max(100-n-e.nextPanesSize-e.nextReachedMinPanes,c.min),c.max))},doPushOtherPanes(i,t){const e=this.touch.activeSplitter,s=[e,e+1];return t<i.prevPanesSize+this.panes[s[0]].min&&(s[0]=this.findPrevExpandedPane(e).index,i.prevReachedMinPanes=0,s[0]<e&&this.panes.forEach((a,n)=>{n>s[0]&&n<=e&&(a.size=a.min,i.prevReachedMinPanes+=a.min)}),i.prevPanesSize=this.sumPrevPanesSize(s[0]),s[0]===void 0)?(i.prevReachedMinPanes=0,this.panes[0].size=this.panes[0].min,this.panes.forEach((a,n)=>{n>0&&n<=e&&(a.size=a.min,i.prevReachedMinPanes+=a.min)}),this.panes[s[1]].size=100-i.prevReachedMinPanes-this.panes[0].min-i.prevPanesSize-i.nextPanesSize,null):t>100-i.nextPanesSize-this.panes[s[1]].min&&(s[1]=this.findNextExpandedPane(e).index,i.nextReachedMinPanes=0,s[1]>e+1&&this.panes.forEach((a,n)=>{n>e&&n<s[1]&&(a.size=a.min,i.nextReachedMinPanes+=a.min)}),i.nextPanesSize=this.sumNextPanesSize(s[1]-1),s[1]===void 0)?(i.nextReachedMinPanes=0,this.panes[this.panesCount-1].size=this.panes[this.panesCount-1].min,this.panes.forEach((a,n)=>{n<this.panesCount-1&&n>=e+1&&(a.size=a.min,i.nextReachedMinPanes+=a.min)}),this.panes[s[0]].size=100-i.prevPanesSize-i.nextReachedMinPanes-this.panes[this.panesCount-1].min-i.nextPanesSize,null):{sums:i,panesToResize:s}},sumPrevPanesSize(i){return this.panes.reduce((t,e,s)=>t+(s<i?e.size:0),0)},sumNextPanesSize(i){return this.panes.reduce((t,e,s)=>t+(s>i+1?e.size:0),0)},findPrevExpandedPane(i){return[...this.panes].reverse().find(e=>e.index<i&&e.size>e.min)||{}},findNextExpandedPane(i){return this.panes.find(e=>e.index>i+1&&e.size>e.min)||{}},checkSplitpanesNodes(){Array.from(this.container.children).forEach(t=>{const e=t.classList.contains("splitpanes__pane"),s=t.classList.contains("splitpanes__splitter");if(!e&&!s){t.parentNode.removeChild(t),console.warn("Splitpanes: Only <pane> elements are allowed at the root of <splitpanes>. One of your DOM nodes was removed.");return}})},addSplitter(i,t,e=!1){const s=i-1,a=document.createElement("div");a.classList.add("splitpanes__splitter"),e||(a.onmousedown=n=>this.onMouseDown(n,s),typeof window<"u"&&"ontouchstart"in window&&(a.ontouchstart=n=>this.onMouseDown(n,s)),a.onclick=n=>this.onSplitterClick(n,s+1)),this.dblClickSplitter&&(a.ondblclick=n=>this.onSplitterDblClick(n,s+1)),t.parentNode.insertBefore(a,t)},removeSplitter(i){i.onmousedown=void 0,i.onclick=void 0,i.ondblclick=void 0,i.parentNode.removeChild(i)},redoSplitters(){const i=Array.from(this.container.children);i.forEach(e=>{e.className.includes("splitpanes__splitter")&&this.removeSplitter(e)});let t=0;i.forEach(e=>{e.className.includes("splitpanes__pane")&&(!t&&this.firstSplitter?this.addSplitter(t,e,!0):t&&this.addSplitter(t,e),t++)})},requestUpdate(i){var t=i,{target:e}=t,s=q(t,["target"]);const a=this.indexedPanes[e._uid];Object.entries(s).forEach(([n,o])=>a[n]=o)},onPaneAdd(i){let t=-1;Array.from(i.$el.parentNode.children).some(a=>(a.className.includes("splitpanes__pane")&&t++,a===i.$el));const e=parseFloat(i.minSize),s=parseFloat(i.maxSize);this.panes.splice(t,0,{id:i._uid,index:t,min:isNaN(e)?0:e,max:isNaN(s)?100:s,size:i.size===null?null:parseFloat(i.size),givenSize:i.size,update:i.update}),this.panes.forEach((a,n)=>a.index=n),this.ready&&this.$nextTick(()=>{this.redoSplitters(),this.resetPaneSizes({addedPane:this.panes[t]}),this.$emit("pane-add",{index:t,panes:this.panes.map(a=>({min:a.min,max:a.max,size:a.size}))})})},onPaneRemove(i){const t=this.panes.findIndex(s=>s.id===i._uid),e=this.panes.splice(t,1)[0];this.panes.forEach((s,a)=>s.index=a),this.$nextTick(()=>{this.redoSplitters(),this.resetPaneSizes({removedPane:N(I({},e),{index:t})}),this.$emit("pane-remove",{removed:e,panes:this.panes.map(s=>({min:s.min,max:s.max,size:s.size}))})})},resetPaneSizes(i={}){!i.addedPane&&!i.removedPane?this.initialPanesSizing():this.panes.some(t=>t.givenSize!==null||t.min||t.max<100)?this.equalizeAfterAddOrRemove(i):this.equalize(),this.ready&&this.$emit("resized",this.panes.map(t=>({min:t.min,max:t.max,size:t.size})))},equalize(){const i=100/this.panesCount;let t=0,e=[],s=[];this.panes.forEach(a=>{a.size=Math.max(Math.min(i,a.max),a.min),t-=a.size,a.size>=a.max&&e.push(a.id),a.size<=a.min&&s.push(a.id)}),t>.1&&this.readjustSizes(t,e,s)},initialPanesSizing(){100/this.panesCount;let i=100,t=[],e=[],s=0;this.panes.forEach(n=>{i-=n.size,n.size!==null&&s++,n.size>=n.max&&t.push(n.id),n.size<=n.min&&e.push(n.id)});let a=100;i>.1&&(this.panes.forEach(n=>{n.size===null&&(n.size=Math.max(Math.min(i/(this.panesCount-s),n.max),n.min)),a-=n.size}),a>.1&&this.readjustSizes(i,t,e))},equalizeAfterAddOrRemove({addedPane:i,removedPane:t}={}){let e=100/this.panesCount,s=0,a=[],n=[];i&&i.givenSize!==null&&(e=(100-i.givenSize)/(this.panesCount-1)),this.panes.forEach(o=>{s-=o.size,o.size>=o.max&&a.push(o.id),o.size<=o.min&&n.push(o.id)}),!(Math.abs(s)<.1)&&(this.panes.forEach(o=>{i&&i.givenSize!==null&&i.id===o.id||(o.size=Math.max(Math.min(e,o.max),o.min)),s-=o.size,o.size>=o.max&&a.push(o.id),o.size<=o.min&&n.push(o.id)}),s>.1&&this.readjustSizes(s,a,n))},readjustSizes(i,t,e){let s;i>0?s=i/(this.panesCount-t.length):s=i/(this.panesCount-e.length),this.panes.forEach((a,n)=>{if(i>0&&!t.includes(a.id)){const o=Math.max(Math.min(a.size+s,a.max),a.min),r=o-a.size;i-=r,a.size=o}else if(!e.includes(a.id)){const o=Math.max(Math.min(a.size+s,a.max),a.min),r=o-a.size;i-=r,a.size=o}a.update({[this.horizontal?"height":"width"]:`${this.indexedPanes[a.id].size}%`})}),Math.abs(i)>.1&&this.$nextTick(()=>{this.ready&&console.warn("Splitpanes: Could not resize panes correctly due to their constraints.")})}},watch:{panes:{deep:!0,immediate:!1,handler(){this.updatePaneComponents()}},horizontal(){this.updatePaneComponents()},firstSplitter(){this.redoSplitters()},dblClickSplitter(i){[...this.container.querySelectorAll(".splitpanes__splitter")].forEach((e,s)=>{e.ondblclick=i?a=>this.onSplitterDblClick(a,s):void 0})}},beforeDestroy(){this.ready=!1},mounted(){this.container=this.$refs.container,this.checkSplitpanesNodes(),this.redoSplitters(),this.resetPaneSizes(),this.$emit("ready"),this.ready=!0},render(i){return i("div",{ref:"container",class:["splitpanes",`splitpanes--${this.horizontal?"horizontal":"vertical"}`,{"splitpanes--dragging":this.touch.dragging}]},this.$slots.default)}};let G,W;const w={};var U=S(H,G,W,!1,V);function V(i){for(let t in w)this[t]=w[t]}var Z=function(){return U.exports}(),X=function(){var i=this,t=i.$createElement,e=i._self._c||t;return e("div",{staticClass:"splitpanes__pane",style:i.style,on:{click:function(s){return i.onPaneClick(s,i._uid)}}},[i._t("default")],2)},J=[];const Y={name:"pane",inject:["requestUpdate","onPaneAdd","onPaneRemove","onPaneClick"],props:{size:{type:[Number,String],default:null},minSize:{type:[Number,String],default:0},maxSize:{type:[Number,String],default:100}},data:()=>({style:{}}),mounted(){this.onPaneAdd(this)},beforeDestroy(){this.onPaneRemove(this)},methods:{update(i){this.style=i}},computed:{sizeNumber(){return this.size||this.size===0?parseFloat(this.size):null},minSizeNumber(){return parseFloat(this.minSize)},maxSizeNumber(){return parseFloat(this.maxSize)}},watch:{sizeNumber(i){this.requestUpdate({target:this,size:i})},minSizeNumber(i){this.requestUpdate({target:this,min:i})},maxSizeNumber(i){this.requestUpdate({target:this,max:i})}}},$={};var K=S(Y,X,J,!1,Q);function Q(i){for(let t in $)this[t]=$[t]}var tt=function(){return K.exports}();const et={props:{publication:{type:Object,required:!0}},components:{MediaPicker:v},data(){return{show_cover_picker:!1,cover_layout_mode_options:[{key:"",text:this.$t("normal")},{key:"full_page",text:this.$t("full_page")},{key:"text_top_image_down",text:this.$t("text_top_image_down")},{key:"image_top_text_down",text:this.$t("image_top_text_down")}]}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{cover_media(){var i;return(i=this.publication.$files)==null?void 0:i.find(t=>t.cover_type==="front")},cover_image_media(){var e,s;const i=(s=(e=this.cover_media)==null?void 0:e.source_medias)==null?void 0:s[0];if(!i)return!1;const t=this.getSourceMedia({source_media:i,folder_path:this.publication.$path});return t||!1}},methods:{async createCover(){const i="frontcover.txt",{meta_filename:t}=await this.$api.uploadText({path:this.publication.$path,filename:i,content:this.$t("title"),additional_meta:{cover_type:"front"}})},async removeCover(){this.$api.deleteItem({path:this.cover_media.$path})},async pickCover(i){const t=i[0],e=this.$root.publication_include_mode,s=await this.prepareMediaForPublication({path_to_source_media_meta:t.$path,publication_path:this.publication.$path,import_mode:e});this.$api.updateMeta({path:this.cover_media.$path,new_meta:{source_medias:[s]}})},async removeImage(){this.$api.updateMeta({path:this.cover_media.$path,new_meta:{source_medias:[]}})}}};var it=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_cover"},[t.cover_media?t._e():e("div",{},[e("DLabel",{attrs:{str:t.$t("cover")}}),e("button",{staticClass:"u-button u-button_bleuvert u-button_small",attrs:{type:"button"},on:{click:t.createCover}},[t._v(" "+t._s(t.$t("create"))+" ")])],1),t.cover_media?[e("div",{staticClass:"u-spacingBottom"},[e("CollaborativeEditor3",{attrs:{label:t.$t("title"),content:t.cover_media.$content,path:t.cover_media.$path,custom_formats:[],save_format:"raw",can_edit:!0}})],1),e("div",{staticClass:"_cover--pickCover"},[t.cover_image_media?[e("div",{staticClass:"_cover--pickCover--img"},[e("MediaContent",{attrs:{file:t.cover_image_media,resolution:1600}}),e("div",{staticClass:"_cover--pickCover--img--buttons"},[e("button",{staticClass:"u-button u-button_bleuvert u-button_small",attrs:{type:"button"},on:{click:function(s){t.show_cover_picker=!0}}},[t._v(" "+t._s(t.$t("change"))+" ")]),e("button",{staticClass:"u-button u-button_red u-button_small",attrs:{type:"button"},on:{click:t.removeImage}},[t._v(" "+t._s(t.$t("remove"))+" ")])])],1)]:[e("button",{staticClass:"u-button u-button_bleuvert u-button_small",attrs:{type:"button"},on:{click:function(s){t.show_cover_picker=!0}}},[t._v(" "+t._s(t.$t("pick_cover"))+" ")])],t.show_cover_picker?e("MediaPicker",{attrs:{publication_path:t.publication.$path,select_mode:"single",pick_from_types:["image"]},on:{pickMedias:t.pickCover,close:function(s){t.show_cover_picker=!1}}}):t._e()],2),e("div",{staticClass:"u-spacingBottom"}),e("DLabel",{attrs:{str:t.$t("text_image_layout")}}),e("SelectField2",{attrs:{field_name:"cover_layout_mode",value:t.cover_media.cover_layout_mode,path:t.cover_media.$path,hide_validation:!0,can_edit:!0,options:t.cover_layout_mode_options}}),e("RemoveMenu",{on:{remove:t.removeCover}})]:t._e()],2)},st=[],at=h(et,it,st,!1,null,"6c6cbdad");const nt=at.exports,ot={props:{section:{type:Object,required:!0},index:Number,number_of_sections:Number,view_mode:String,chapters_positions:Array,pages_positions:Object},components:{},data(){return{}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{gallery_medias(){var i;return this.section.section_type!=="gallery"||!this.section.source_medias?[]:(i=this.section.source_medias)==null?void 0:i.map(t=>this.getSourceMedia({source_media:t,folder_path:this.getParent(this.section.$path)}))}},methods:{previewContent(i){var e;const t=(e=i._main_text)==null?void 0:e.$content;return t?t.substring(0,200)+"...":!1}}};var rt=function(){var s;var t=this,e=t._self._c;return e("div",{staticClass:"_chapterPreview"},[e("div",{staticClass:"_selects"},[e("select",{staticClass:"_selects--order",attrs:{size:"small"},domProps:{value:t.index},on:{change:function(a){return t.$emit("moveSection",{old_position:t.index,new_position:+a.target.value})}}},t._l(t.number_of_sections,function(a){return e("option",{key:a-1,domProps:{value:a-1,textContent:t._s(a)}})}),0),e("transition",{attrs:{name:"fade",mode:"out-in"}},[t.view_mode==="book"&&((s=t.pages_positions)!=null&&s.first_page)?e("div",{key:t.pages_positions.first_page,staticClass:"_selects--pageRange"},[t._v(" p."+t._s(t.pages_positions.first_page)+" "),t.pages_positions.first_page!==t.pages_positions.last_page?[e("b-icon",{attrs:{icon:"arrow-right-short"}}),t._v(" p."+t._s(t.pages_positions.last_page)+" ")]:t._e()],2):t._e()])],1),e("div",{staticClass:"u-card2 _chapterPreview--card"},[e("div",{staticClass:"_topRow"},[e("h2",{staticClass:"_item--title"},[t.section.section_title?[t._v(" "+t._s(t.section.section_title)+" ")]:[e("i",[t._v(t._s(t.$t("untitled")))])],e("small",{staticClass:"_item--title--icon"},[t.section.section_type==="text"?e("b-icon",{attrs:{icon:"markdown"}}):t.section.section_type==="gallery"?e("b-icon",{attrs:{icon:"image"}}):t._e()],1)],2)]),e("div",{staticClass:"_item--content"},[t.section.section_type==="text"?e("div",{staticClass:"_item--content--text"},[t.previewContent(t.section)?[e("CollaborativeEditor3",{attrs:{content:t.previewContent(t.section)}})]:[e("span",{staticClass:"u-instructions"},[t._v(" "+t._s(t.$t("no_content"))+" ")])]],2):t.section.section_type==="gallery"&&t.gallery_medias.length>0?e("div",{staticClass:"_item--content--gallery"},t._l(t.gallery_medias,function(a){return e("div",{key:a.$path},[e("MediaContent",{attrs:{file:a}})],1)}),0):t.section.section_type==="grid"?e("div",{staticClass:"_item--content--grid"},[t.section.grid_areas&&t.section.grid_areas.length>0?e("span",{staticClass:"u-instructions"},[t._v(" "+t._s(t.$t("areas_used",{count:t.section.grid_areas.length}))+" ")]):e("span",{staticClass:"u-instructions"},[t._v(" "+t._s(t.$t("no_areas_defined"))+" ")])]):t._e()]),e("button",{staticClass:"_openButton",attrs:{type:"button",title:t.$t("open")},on:{click:function(a){return t.$emit("open")}}})])])},ct=[],_t=h(ot,rt,ct,!1,null,"05bab96e");const lt=_t.exports,dt={props:{publication:Object,sections:Array,opened_section_meta_filename:String,view_mode:String,chapters_positions:Object},components:{ChapterPreview:lt,SetCover:nt},data(){return{}},created(){},mounted(){},beforeDestroy(){},watch:{opened_section_meta_filename(){}},computed:{is_associated_to_map(){return this.$getMapOptions},new_section_index(){let i=this.sections.length+1;const t=s=>" "+s;let e=t(i);for(;this.sections.some(s=>s.section_title.endsWith(e));)i++,e=t(i);return e},opened_section(){return this.sections.find(i=>this.getFilename(i.$path)===this.opened_section_meta_filename)}},methods:{openSection(i){this.$emit("toggleSection",this.getFilename(i))},async createSection({type:i="text"}={}){let t={section_starts_on_page:"page"};if(i==="text"){const s=this.new_section_title+" text.txt",{meta_filename:a}=await this.$api.uploadText({path:this.publication.$path,filename:s,content:"",additional_meta:{content_type:"markdown"}});t.section_title=this.$t("section")+" "+this.new_section_index,t.section_type="text",t.main_text_meta=a}else i==="gallery"?(t.section_title=this.$t("gallery")+" "+this.new_section_index,t.section_type="gallery"):i==="grid"?(t.section_title=this.$t("grid")+" "+this.new_section_index,t.section_type="grid"):i==="story"&&(t.section_title=this.$t("story")+" "+this.new_section_index,t.section_type="story");const e=await this.createSection2({publication:this.publication,additional_meta:t});setTimeout(()=>{this.$emit("toggleSection",e)},100)},async moveSection({old_position:i,new_position:t}){const e=this.getFilename(this.sections[i].$path);let s=this.sections.map(n=>({meta_filename:this.getFilename(n.$path)}));function a(n,o,r){if(r>=n.length)for(var c=r-n.length+1;c--;)n.push(void 0);return n.splice(r,0,n.splice(o,1)[0]),n}a(s,i,t),await this.$api.updateMeta({path:this.publication.$path,new_meta:{sections_list:s}}),setTimeout(()=>{this.$eventHub.$emit("edition.zoomToSection",e)},500)},getPagesPositions(i){const t=this.getFilename(i);return this.chapters_positions[t]}}};var ut=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_chaptersSummary"},[e("div",{staticClass:"_content"},[e("transition-group",{key:"allpages",staticClass:"_allChapters",attrs:{tag:"div",name:"listComplete",appear:""}},[e("SetCover",{key:"cover",attrs:{publication:t.publication}}),t._l(t.sections,function(s,a){return e("ChapterPreview",{key:s.$path,attrs:{section:s,index:a,number_of_sections:t.sections.length,view_mode:t.view_mode,pages_positions:t.getPagesPositions(s.$path)},on:{open:function(n){return t.openSection(s.$path)},moveSection:t.moveSection}})}),e("div",{key:"'add'",staticClass:"_addSection"},[e("button",{staticClass:"u-button u-button_small u-button_white",attrs:{type:"button"},on:{click:function(s){return t.createSection({type:"text"})}}},[e("b-icon",{attrs:{icon:"fonts"}}),t._v(" "+t._s(t.$t("text"))+" ")],1),e("button",{staticClass:"u-button u-button_small u-button_white",attrs:{type:"button"},on:{click:function(s){return t.createSection({type:"grid"})}}},[e("b-icon",{attrs:{icon:"grid-3x2-gap-fill"}}),t._v(" "+t._s(t.$t("grid"))+" ")],1)])],2)],1)])},ht=[],pt=h(dt,ut,ht,!1,null,"71a1fc4b");const mt=pt.exports,ft={props:{chapter:Object,publication:Object},components:{MediaPicker:v},data(){return{show_media_picker:!1}},computed:{gallery_medias(){const i=[];if(this.chapter.section_type!=="gallery"||!this.chapter.source_medias)return[];for(const t of this.chapter.source_medias){const e=this.getParent(this.chapter.$path),s=this.getSourceMedia({source_media:t,folder_path:e});s&&i.push(s)}return i}},methods:{async pickMediasForGallery(i){const t=[];for(const a of i){const n=this.$root.publication_include_mode,o=await this.prepareMediaForPublication({path_to_source_media_meta:a.$path,publication_path:this.publication.$path,import_mode:n});t.push(o)}const s=[...this.chapter.source_medias||[],...t];this.$api.updateMeta({path:this.chapter.$path,new_meta:{source_medias:s}})},removeMedia(i){const t=this.chapter.source_medias.filter(e=>e.meta_filename_in_project!==this.getFilename(i.$path));this.$api.updateMeta({path:this.chapter.$path,new_meta:{source_medias:t}})}}};var gt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_galleryChapter"},[e("transition-group",{staticClass:"_gallery",attrs:{tag:"div",name:"StoryModules",appear:""}},[t._l(t.gallery_medias,function(s){return e("div",{key:s.$path,staticClass:"_gallery--item"},[e("MediaContent",{attrs:{file:s,context:"full"}}),e("div",{staticClass:"_remove_media"},[e("RemoveMenu",{attrs:{show_button_text:!1},on:{remove:function(a){return t.removeMedia(s)}}})],1)],1)}),e("div",{key:"add_medias",staticClass:"_add_medias"},[e("button",{staticClass:"u-button u-button_bleuvert",attrs:{type:"button"},on:{click:function(s){t.show_media_picker=!0}}},[t._v(" "+t._s(t.$t("add_medias"))+" ")])])],2),t.show_media_picker?e("MediaPicker",{attrs:{publication_path:t.publication.$path,select_mode:"multiple",pick_from_types:["image"]},on:{pickMedias:t.pickMediasForGallery,close:function(s){t.show_media_picker=!1}}}):t._e()],1)},vt=[],bt=h(ft,gt,vt,!1,null,"a9c65ddf");const yt=bt.exports,wt={name:"PickMediaForMarkdown",components:{MediaPicker:v,CodeBlock:A},props:{publication_path:String},data(){return{show_media_picker:!0,medias_were_picked:!1,isCopied:!1,pick_medias_list:[],pick_medias_text:"",medias_on_new_line:!1}},watch:{medias_on_new_line(i){this.pick_medias_text=this.makeStringFromMedias(this.pick_medias_list,this.medias_on_new_line)}},methods:{async pickMedias(i){this.medias_were_picked=!0;let t=[];for(const e of i){const s=this.$root.publication_include_mode,a=await this.prepareMediaForPublication({path_to_source_media_meta:e.$path,publication_path:this.publication_path,import_mode:s});a.$type=e.$type,a.$content=e.$content,a.caption=e.caption,t.push(a)}this.pick_medias_list=t,this.pick_medias_text=this.makeStringFromMedias(this.pick_medias_list,this.medias_on_new_line)},makeStringFromMedias(i,t){let e=[];return i.map(s=>{if(s.$type==="text"){const r=this.turnHtmlToMarkdown(s.$content);e.push(r);return}let a="(",n;s.hasOwnProperty("meta_filename_in_project")?n="../"+s.meta_filename_in_project:s.hasOwnProperty("meta_filename")&&(n="./"+s.meta_filename);let o;if(s.$type==="image")o="image";else if(s.$type==="video")o="video";else if(s.$type==="audio")o="audio";else if(s.$type==="pdf")o="pdf";else throw new Error("Unknown media type");if(a+=`${o}: ${n}`,s.caption){const r=this.turnHtmlToMarkdown(s.caption);if(r&&r.trim()!==""){const c=r.replace(/\n/g," · ");a+=` caption: ${c}`}}a+=")",e.push(a)}),t?e=e.join(`

`):e=e.join(" "),e+=`

`,e},turnHtmlToMarkdown(i){const t=document.createElement("div");t.innerHTML=i;let e="";const s=t.querySelectorAll("p");return s.forEach((a,n)=>{let o=a.textContent;a.querySelectorAll("a").forEach(c=>{const _=c.textContent,l=c.getAttribute("href");if(l){const d=`[${_}](${l})`;o=o.replace(_,d)}}),e+=o+(n<s.length-1?`
`:"")}),e},copyToClipboard(){this.isCopied=!1;var i=this.$refs.urlToCopy;i.select(),i.setSelectionRange(0,99999),navigator.clipboard.writeText(i.value),this.isCopied=!0},closePickModal(){this.medias_were_picked=!1,this.isCopied=!1,this.$emit("close")},insertToText(){this.$emit("insertToText",this.pick_medias_text),this.closePickModal()}}};var $t=function(){var t=this,e=t._self._c;return e("div",{staticClass:"pick-media-for-markdown"},[e("BaseModal2",{attrs:{title:t.$t("add_media")},on:{close:t.closePickModal},scopedSlots:t._u([t.medias_were_picked?{key:"footer",fn:function(){return[e("div"),e("button",{staticClass:"u-button u-button_bleuvert",attrs:{type:"button"},on:{click:t.insertToText}},[t._v(" "+t._s(t.$t("add"))+" ")])]},proxy:!0}:null],null,!0)},[t.pick_medias_text?t._e():e("div",{staticClass:"u-spacingBottom"},[e("DLabel",{attrs:{str:t.$t("from_project")}}),e("button",{staticClass:"u-button u-button_orange _pickMediaBtn",attrs:{type:"button"},on:{click:function(s){t.show_media_picker=!0}}},[e("b-icon",{attrs:{icon:"image"}}),t._v(" "+t._s(t.$t("import"))+" ")],1)],1),t.show_media_picker?e("MediaPicker",{attrs:{publication_path:t.publication_path,select_mode:"multiple",pick_from_types:["image","video","audio","text","pdf"]},on:{pickMedias:t.pickMedias,close:function(s){t.show_media_picker=!1}}}):t._e(),t.pick_medias_text?[e("div",{staticClass:"u-spacingBottom u-inputGroup"},[e("textarea",{directives:[{name:"model",rawName:"v-model",value:t.pick_medias_text,expression:"pick_medias_text"}],ref:"urlToCopy",staticClass:"_textField",domProps:{value:t.pick_medias_text},on:{input:function(s){s.target.composing||(t.pick_medias_text=s.target.value)}}}),t._v(" "),e("button",{staticClass:"u-button u-button_icon u-suffix _clipboardBtn",attrs:{type:"button"},on:{click:t.copyToClipboard}},[t.isCopied?e("b-icon",{attrs:{icon:"clipboard-check"}}):e("b-icon",{attrs:{icon:"clipboard"}})],1)]),t.pick_medias_list.length>1?e("div",{staticClass:"u-spacingBottom"},[e("DLabel",{attrs:{str:t.$t("layout")}}),e("label",{staticClass:"u-switch u-switch-xs u-switch_twoway"},[e("label",{staticClass:"_switchLabel",attrs:{for:"medias_on_new_line"}},[t._v(" "+t._s(t.$t("side_by_side"))+" "),e("b-icon",{attrs:{icon:"three-dots"}})],1),e("input",{directives:[{name:"model",rawName:"v-model",value:t.medias_on_new_line,expression:"medias_on_new_line"}],attrs:{id:"medias_on_new_line",type:"checkbox"},domProps:{checked:Array.isArray(t.medias_on_new_line)?t._i(t.medias_on_new_line,null)>-1:t.medias_on_new_line},on:{change:function(s){var a=t.medias_on_new_line,n=s.target,o=!!n.checked;if(Array.isArray(a)){var r=null,c=t._i(a,r);n.checked?c<0&&(t.medias_on_new_line=a.concat([r])):c>-1&&(t.medias_on_new_line=a.slice(0,c).concat(a.slice(c+1)))}else t.medias_on_new_line=o}}}),e("label",{staticClass:"_switchLabel",attrs:{for:"medias_on_new_line"}},[t._v(" "+t._s(t.$t("new_line"))+" "),e("b-icon",{attrs:{icon:"three-dots-vertical"}})],1)])],1):t._e()]:t._e(),e("DetailsPane",{attrs:{header:t.$t("advanced_options"),icon:"rulers",has_items:!1}},[e("hr"),t._v(" "+t._s(t.$t("multisupport_embed_img_instr"))+" "),e("CodeBlock",{attrs:{code:"(image: https://www.pageweb.com/image.jpeg)",explanation:t.$t("embed_example_image")}}),e("CodeBlock",{attrs:{code:"(video: https://www.pageweb.com/video.mp4)",explanation:t.$t("embed_example_video")}}),e("CodeBlock",{attrs:{code:"(audio: https://www.pageweb.com/audio.mp3)",explanation:t.$t("embed_example_audio")}}),e("CodeBlock",{attrs:{code:"(pdf: https://www.pageweb.com/document.pdf)",explanation:t.$t("embed_example_pdf")}}),e("CodeBlock",{attrs:{code:"(embed: https://peertube.fr/w/wB6M6CHdfpWXpozVnqjbde)",explanation:t.$t("embed_example_peertube")}}),e("CodeBlock",{attrs:{code:"(embed: https://www.youtube.com/watch?v=Bn6zdyCAwJs)",explanation:t.$t("embed_example_youtube")}}),e("CodeBlock",{attrs:{code:"(embed: https://scratch.mit.edu/projects/1061783643)",explanation:t.$t("embed_example_scratch")}}),e("div",{staticClass:"u-spacingBottom"},[t._v(" "+t._s(t.$t("attributes_for_embeds"))+" "),e("CodeBlock",{attrs:{code:"caption: Ma légende",explanation:t.$t("embed_attr_caption")}}),e("CodeBlock",{attrs:{code:"class: nomDeLaClasse",explanation:t.$t("embed_attr_class")}}),e("CodeBlock",{attrs:{code:"float: left",explanation:t.$t("embed_attr_float_left")}}),e("CodeBlock",{attrs:{code:"float: right",explanation:t.$t("embed_attr_float_right")}}),e("CodeBlock",{attrs:{code:"size: full",explanation:t.$t("embed_attr_size_full")}}),e("CodeBlock",{attrs:{code:"size: full-cover",explanation:t.$t("embed_attr_size_full_cover")}}),e("CodeBlock",{attrs:{code:"width: 5cm",explanation:t.$t("embed_attr_width")}})],1),e("div",[t._v(" "+t._s(t.$t("for_example"))+" "),e("div",[e("CodeBlock",{attrs:{code:"(embed: https://peertube.fr/w/wB6M6CHdfpWXpozVnqjbde caption: Voici une vidéo de PeerTube class: maClass)"}})],1)])],1),e("div",{staticClass:"u-spacingBottom"}),t.medias_were_picked?e("div",{staticClass:"u-instructions"},[t._v(" "+t._s(t.$t("copy_paste_to_include_media_or_click_to_add_at_cursor"))+" ")]):t._e()],2)],1)},xt=[],Ct=h(wt,$t,xt,!1,null,"bfc8d616");const kt=Ct.exports,St={props:{text_file:Object,medias_holder:Object,publication_path:String,show_label:{type:Boolean,default:!0},can_edit:{type:Boolean,default:!0}},components:{PickMediaForMarkdown:kt},data(){return{show_media_picker:!1}},computed:{content_type(){var i;return((i=this.text_file)==null?void 0:i.content_type)||"html"},custom_formats(){if(this.content_type==="markdown")return[]},save_format(){return this.content_type==="html"?"html":this.content_type==="markdown"?"raw":"html"},main_text_content(){var i;return(i=this.text_file)==null?void 0:i.$content}},watch:{main_text_content:{handler(i){i&&this.listAllEmbeddedMedias(i)},deep:!0}},methods:{listAllEmbeddedMedias(i){let t=[];const e=new T;e.use(j,{getMediaSrc:n=>{const o=this.publication_path;let r=this.transformMediaSrc(n);return this.getSourceMedia({source_media:r,folder_path:o})},vue_instance:this});const s=e.renderer.rules.image||function(n,o,r,c,_){return _.renderToken(n,o,r)};e.renderer.rules.image=(n,o,r,c,_)=>{const l=n[o],d=l.attrIndex("src");if(d>=0){const u=l.attrs[d][1],p=this.publication_path;this.getSourceMedia({source_media:{meta_filename_in_project:u},folder_path:p})&&t.push({meta_filename_in_project:u})}return s(n,o,r,c,_)};const a=e.renderer.rules.csc;e.renderer.rules.csc=(n,o)=>{const r=n[o];if(["image","video","audio","pdf"].includes(r.tag)&&r.content){const c=r.content,_=this.publication_path,l=this.transformMediaSrc(c);this.getSourceMedia({source_media:l,folder_path:_})&&t.push(l)}return a?a(n,o):""},e.render(i),t=t.filter((n,o,r)=>{const c=n.meta_filename_in_project||n.meta_filename;if(!c)return!0;const _=r.findIndex(l=>{const d=l.meta_filename_in_project||l.meta_filename;return d&&d===c});return o===_}),JSON.stringify(t)!==JSON.stringify(this.medias_holder.source_medias)&&this.$api.updateMeta({path:this.medias_holder.$path,new_meta:{source_medias:t}})},closePickModal(){this.show_media_picker=!1},insertToText(i){const t=this.$refs.collaborativeEditor;t&&t.insertAtCursor(i)},transformMediaSrc(i){return i.startsWith("./")?{meta_filename:i.substring(2)}:i.startsWith("../")?{meta_filename_in_project:i.substring(3)}:{meta_filename_in_project:i}}}};var zt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_mainText"},[t.show_label?e("DLabel",{attrs:{str:t.$t("content")}}):t._e(),e("CollaborativeEditor3",{ref:"collaborativeEditor",attrs:{content:t.main_text_content,path:t.text_file.$path,custom_formats:t.custom_formats,save_format:t.save_format,content_type:"markdown",can_edit:t.can_edit},scopedSlots:t._u([{key:"custom_buttons",fn:function(){return[e("button",{staticClass:"u-button u-button_orange",attrs:{type:"button"},on:{click:function(s){t.show_media_picker=!t.show_media_picker}}},[e("b-icon",{attrs:{icon:"image"}}),t._v(" "+t._s(t.$t("import"))+" ")],1)]},proxy:!0}])}),t.show_media_picker?e("PickMediaForMarkdown",{attrs:{publication_path:t.publication_path},on:{insertToText:t.insertToText,close:t.closePickModal}}):t._e()],1)},Mt=[],Pt=h(St,zt,Mt,!1,null,"04a6718e");const z=Pt.exports,At={props:{area:{type:Object,required:!0},chapter:{type:Object,required:!0},publication:Object},components:{MainText:z,MediaPicker:v},data(){return{show_media_picker:!1}},created(){},mounted(){this.$eventHub.$on("gridArea.delete",this.handleAreaDeletion)},beforeDestroy(){this.$eventHub.$off("gridArea.delete",this.handleAreaDeletion)},watch:{},computed:{area_source_media(){var i,t;return(t=(i=this.area)==null?void 0:i.source_medias)==null?void 0:t[0]},area_file_from_source_medias(){if(this.area_source_media)return this.getSourceMedia({source_media:this.area_source_media,folder_path:this.publication.$path})},area_current_file(){return this.area_file_from_source_medias},area_is_text(){var i,t;return((i=this.area_current_file)==null?void 0:i.$type)==="text"||((t=this.area_current_file)==null?void 0:t.content_type)==="markdown"},area_objectFit(){var i;return((i=this.area)==null?void 0:i.objectFit)||"cover"},area_objectPosition(){var i;return((i=this.area)==null?void 0:i.objectPosition)||"center"}},methods:{async createText(){const i=this.area.id,e=`${this.chapter.$path.split("/").pop()}-${i}_text.md`,{meta_filename:s}=await this.$api.uploadText({path:this.publication.$path,filename:e,content:"",additional_meta:{content_type:"markdown"}}),a=this.chapter.grid_areas.map(o=>o.id===i?{...o,source_medias:[{meta_filename:s}]}:o);await this.$api.updateMeta({path:this.chapter.$path,new_meta:{grid_areas:a}});const n=this.publication.$path+"/"+s;setTimeout(()=>{this.$eventHub.$emit("media.enableEditor."+n)},150)},async pickMediaForArea(i){const t=i==null?void 0:i[0];if(!t)return;const e=this.area.id,s=this.$root.publication_include_mode,a=await this.prepareMediaForPublication({path_to_source_media_meta:t.$path,publication_path:this.publication.$path,import_mode:s}),n=this.chapter.grid_areas.map(o=>o.id===e?{...o,source_medias:[a],objectFit:"cover",objectPosition:"center"}:o);this.$api.updateMeta({path:this.chapter.$path,new_meta:{grid_areas:n}}),this.show_media_picker=!1},async removeAreaText(){const i=this.area.id,t=this.area_current_file,e=this.chapter.grid_areas.map(s=>s.id===i?{...s,source_medias:[]}:s);await this.$api.updateMeta({path:this.chapter.$path,new_meta:{grid_areas:e}}),t!=null&&t.$path&&t.$type==="text"&&t.$path.startsWith(this.publication.$path+"/")&&await this.$api.deleteItem({path:t.$path})},removeAreaMedia(){const i=this.area.id,t=this.chapter.grid_areas.map(e=>e.id===i?{...e,source_medias:[]}:e);this.$api.updateMeta({path:this.chapter.$path,new_meta:{grid_areas:t}})},toggleObjectFit(){const i=this.area.id,t=this.area_objectFit==="contain"?"cover":"contain",e=this.chapter.grid_areas.map(s=>s.id===i?{...s,objectFit:t,objectPosition:"center"}:s);this.$api.updateMeta({path:this.chapter.$path,new_meta:{grid_areas:e}})},async handleAreaDeletion(i){if(i!==this.area.id)return;const t=this.area_current_file;t!=null&&t.$path&&t.$type==="text"&&t.$path.startsWith(this.publication.$path+"/")&&await this.$api.deleteItem({path:t.$path})}}};var Ft=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_gridItem"},[e("div",{staticClass:"_gridItem--header"},[e("h3",{staticClass:"_gridItem--label"},[t._v(" "+t._s(t.area.id)+" "),t.area.number_of_areas_in_chain>1?t._l(t.area.number_of_areas_in_chain-1,function(s){return e("span",{key:s,staticClass:"_gridItem--chainCount"},[t._v(" -> "+t._s(t.area.id)+t._s(s)+" ")])}):t._e()],2)]),e("div",{staticClass:"_gridItem--content"},[t.area_current_file?t.area_is_text?e("div",[e("MainText",{attrs:{text_file:t.area_current_file,medias_holder:t.area_current_file,publication_path:t.publication.$path,show_label:!1}}),e("button",{staticClass:"u-button u-button_red u-button_small",attrs:{type:"button"},on:{click:t.removeAreaText}},[e("b-icon",{staticStyle:{"font-size":"var(--icon-size)"},attrs:{icon:"trash"}}),t._v(" "+t._s(t.$t("remove"))+" ")],1)],1):e("div",{staticClass:"_gridItem--media",style:{"--object-fit":t.area_objectFit,"--object-position":t.area_objectPosition}},[e("MediaContent",{attrs:{file:t.area_current_file,resolution:1600}}),e("div",{staticClass:"_gridItem--mediaActions"},[e("button",{staticClass:"u-button u-button_bleuvert u-button_small",attrs:{type:"button",title:t.area_objectFit==="contain"?t.$t("object_fit_contain"):t.$t("object_fit_cover")},on:{click:function(s){return s.stopPropagation(),t.toggleObjectFit.apply(null,arguments)}}},[e("b-icon",{attrs:{icon:t.area_objectFit==="contain"?"aspect-ratio":"aspect-ratio-fill"}}),t._v(" "+t._s(t.$t("object_fit"))+" ")],1),e("button",{staticClass:"u-button u-button_orange u-button_small",attrs:{type:"button"},on:{click:function(s){t.show_media_picker=!0}}},[e("b-icon",{staticStyle:{"font-size":"var(--icon-size)"},attrs:{icon:"image"}}),t._v(" "+t._s(t.$t("change"))+" ")],1),e("button",{staticClass:"u-button u-button_red u-button_small",attrs:{type:"button"},on:{click:t.removeAreaMedia}},[e("b-icon",{staticStyle:{"font-size":"var(--icon-size)"},attrs:{icon:"trash"}}),t._v(" "+t._s(t.$t("remove"))+" ")],1)])],1):e("div",{staticClass:"_gridItem--actions"},[e("button",{staticClass:"u-button u-button_bleuvert",attrs:{type:"button"},on:{click:t.createText}},[e("b-icon",{staticStyle:{"font-size":"var(--icon-size)"},attrs:{icon:"fonts"}}),t._v(" "+t._s(t.$t("add_text"))+" ")],1),e("button",{staticClass:"u-button u-button_orange",attrs:{type:"button"},on:{click:function(s){t.show_media_picker=!0}}},[e("b-icon",{staticStyle:{"font-size":"var(--icon-size)"},attrs:{icon:"image"}}),t._v(" "+t._s(t.$t("add_image"))+" ")],1)])]),t.show_media_picker?e("MediaPicker",{attrs:{publication_path:t.publication.$path,select_mode:"single",pick_from_types:["image"]},on:{pickMedias:t.pickMediaForArea,close:function(s){t.show_media_picker=!1}}}):t._e()],1)},Ot=[],Tt=h(At,Ft,Ot,!1,null,"8a353939");const jt=Tt.exports,Bt={props:{chapter:Object,publication:Object},components:{GridItem:jt},data(){return{}},computed:{sorted_grid_areas(){const i=this.chapter.grid_areas;return!i||Array.isArray(i)&&i.length===0?[]:i.filter(t=>t.id.length===1).sort((t,e)=>t.id.localeCompare(e.id)).reduce((t,e)=>{const s=i.filter(a=>a.id.startsWith(e.id)).length;return t.push({...e,number_of_areas_in_chain:s}),t},[])}},methods:{}};var Rt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_gridChapter"},[e("div",{staticClass:"_gridItems"},t._l(t.sorted_grid_areas,function(s){return e("GridItem",{key:s.id,attrs:{area:s,chapter:t.chapter,publication:t.publication}})}),1)])},Et=[],Dt=h(Bt,Rt,Et,!1,null,"d60097f8");const Lt=Dt.exports,It={props:{area:{type:Object,required:!0},selectedAreaId:{type:String,default:null},draggingAreaId:{type:String,default:null},updatingAreaId:{type:String,default:null},publication:{type:Object,required:!0},columnCount:{type:Number,required:!0},rowCount:{type:Number,required:!0},area_type:String,is_last_of_text_chain:Boolean,is_being_chained:Boolean},computed:{clampedGridStyle(){const i=Math.max(1,Math.min(this.area.column_start,this.columnCount)),t=Math.min(this.area.column_end,this.columnCount+1),e=Math.max(1,Math.min(this.area.row_start,this.rowCount)),s=Math.min(this.area.row_end,this.rowCount+1);return{gridColumnStart:i,gridColumnEnd:t,gridRowStart:e,gridRowEnd:s}},isSelected(){return this.selectedAreaId===this.area.id},isDragging(){return this.draggingAreaId===this.area.id},isUpdating(){return this.updatingAreaId===this.area.id}},methods:{}};var Nt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_gridArea",class:{"_gridArea--selected":t.isSelected,"_gridArea--dragging":t.isDragging,"_gridArea--updating":t.isUpdating},style:t.clampedGridStyle,on:{click:function(s){return t.$emit("select",t.area.id)},mousedown:function(s){return t.$emit("drag-start",t.area.id,s)}}},[t.isUpdating?e("div",{staticClass:"_loadingOverlay"},[e("div",{staticClass:"_spinner"})]):t._e(),e("div",{staticClass:"_gridArea--label"},[e("strong",[t._v(t._s(t.area.id))]),t.area_type?e("span",{staticClass:"_gridArea--type"},[t._v("("+t._s(t.$t(t.area_type))+")")]):t._e(),t.is_last_of_text_chain===!0?[t._v("   "),e("button",{staticClass:"u-button u-button_small u-button_icon _chainButtonBtn",class:{"is--active":t.is_being_chained},attrs:{type:"button"},on:{click:function(s){return t.$emit("toggle-chain",t.area.id)}}},[e("b-icon",{attrs:{icon:"link",scale:"1"}})],1)]:t._e()],2),e("div",{staticClass:"_resizeHandle",on:{mousedown:function(s){return s.stopPropagation(),t.$emit("resize-start",t.area.id,s)}}},[e("svg",{attrs:{width:"24",height:"24",viewBox:"0 0 12 12"}},[e("path",{attrs:{d:"M12 0 L12 12 L0 12 Z",fill:"currentColor"}})])]),e("div",{staticClass:"_deleteArea",on:{click:function(s){s.stopPropagation()}}},[e("RemoveMenu",{attrs:{show_button_text:!1,modal_title:t.$t("remove_area"),modal_expl:t.$t("remove_area_confirm")},on:{remove:function(s){return t.$emit("delete",t.area.id)}},scopedSlots:t._u([{key:"trigger",fn:function(){return[e("button",{staticClass:"_deleteAreaBtn",attrs:{type:"button"}},[e("b-icon",{attrs:{icon:"trash",scale:"1"}})],1)]},proxy:!0}])})],1)])},qt=[],Ht=h(It,Nt,qt,!1,null,"4a0f0d93");const Gt=Ht.exports,Wt={mixins:[F],props:{chapter:{type:Object,required:!0},publication:{type:Object,required:!0}},components:{GridArea:Gt},data(){return{selected_area_id:null,resizing_area_id:null,dragging_area_id:null,drag_start_pos:null,resize_start_pos:null,initial_area_position:null,temp_grid_areas:null,updating_area_id:null,toggle_chain_area_id:null,is_mounted:!1,container_size:{width:0,height:0},resize_observer:null}},computed:{column_count(){return this.chapter.column_count||6},row_count(){return this.chapter.row_count||6},grid_areas(){return(this.temp_grid_areas||this.chapter.grid_areas||[]).map(t=>this.clampAreaToBounds(t))},text_chain_links(){if(!this.is_mounted||!this.$el)return[];if(!this.$el.querySelector("._gridOverlay"))return[];this.container_size.width+this.container_size.height;const t=[];return this.getTextChains().forEach(s=>{if(s.length<2)return;const a=[...s].sort((n,o)=>{const r=n.id.match(/^([A-Z]+)(\d*)$/),c=o.id.match(/^([A-Z]+)(\d*)$/),_=r[2]?parseInt(r[2]):0,l=c[2]?parseInt(c[2]):0;return _-l});for(let n=0;n<a.length-1;n++){const o=a[n],r=a[n+1],c=this.generateLinkPath(o,r);c&&t.push({path:c,from:o.id,to:r.id})}}),t}},methods:{generateNextLetterId(){const i=this.grid_areas.map(s=>s.id);let t=0,e=this.getAreaLetter(t);for(;i.includes(e);)t++,e=this.getAreaLetter(t);return e},updateChapter(i){this.$api.updateMeta({path:this.chapter.$path,new_meta:i})},async deleteArea(i){this.$eventHub.$emit("gridArea.delete",i);const t=this.chapter.grid_areas.filter(e=>e.id!==i);this.updateChapter({grid_areas:t})},selectArea(i){this.selected_area_id=i},findAreaById(i){return this.grid_areas.find(t=>t.id===i)},getAreaLetter(i){let t="",e=i;for(;e>=0;)t=String.fromCharCode(65+e%26)+t,e=Math.floor(e/26)-1;return t},getAreaMediaFileType(i){var s;const t=(s=i.source_medias)==null?void 0:s[0];if(!t)return null;const e=this.getSourceMedia({source_media:t,folder_path:this.publication.$path});return e?e.$type==="text"||e.content_type==="markdown"?"text":e.$type==="image"?"image":null:null},getAreaFileType(i){return this.isPartOfTextChain(i)?"text":this.getAreaMediaFileType(i)},getCellPosition(i){const t=Math.ceil(i/this.column_count);return{col:(i-1)%this.column_count+1,row:t}},clampAreaToBounds(i){const t=i.column_end-i.column_start,e=i.row_end-i.row_start;let s=Math.max(1,Math.min(i.column_start,this.column_count)),a=Math.max(1,Math.min(i.row_start,this.row_count)),n=Math.min(s+t,this.column_count+1),o=Math.min(a+e,this.row_count+1);return n<=s&&(n=s+1),o<=a&&(o=a+1),n>this.column_count+1&&(s=Math.max(1,this.column_count+1-t),n=this.column_count+1),o>this.row_count+1&&(a=Math.max(1,this.row_count+1-e),o=this.row_count+1),{...i,column_start:s,column_end:n,row_start:a,row_end:o}},isCellOccupied(i){const{col:t,row:e}=this.getCellPosition(i);return this.grid_areas.some(s=>t>=s.column_start&&t<s.column_end&&e>=s.row_start&&e<s.row_end)},async addAreaAtCell(i){if(this.isCellOccupied(i))return;const{col:t,row:e}=this.getCellPosition(i);if(t>this.column_count||e>this.row_count)return;let s;if(this.toggle_chain_area_id){const o=this.toggle_chain_area_id.match(/^([A-Z]+)(\d*)$/);if(o){const r=o[1],c=this.grid_areas.filter(l=>{const d=l.id.match(/^([A-Z]+)(\d*)$/);return d&&d[1]===r});let _=0;c.forEach(l=>{const d=l.id.match(/^([A-Z]+)(\d*)$/);if(d&&d[2]){const u=parseInt(d[2]);!isNaN(u)&&u>_&&(_=u)}}),s=r+(_+1)}else s=this.generateNextLetterId();this.toggle_chain_area_id=null}else s=this.generateNextLetterId();const a={id:s,column_start:Math.min(t,this.column_count),column_end:Math.min(t+1,this.column_count+1),row_start:Math.min(e,this.row_count),row_end:Math.min(e+1,this.row_count+1)},n=[...this.grid_areas,a];this.updateChapter({grid_areas:n})},startDrag(i,t){this.dragging_area_id=i,this.drag_start_pos={x:t.clientX,y:t.clientY};const e=this.findAreaById(i);this.initial_area_position={column_start:e.column_start,column_end:e.column_end,row_start:e.row_start,row_end:e.row_end},this.temp_grid_areas=JSON.parse(JSON.stringify(this.chapter.grid_areas||[])),document.addEventListener("mousemove",this.handleDrag),document.addEventListener("mouseup",this.stopDrag)},handleDrag(i){if(this.dragging_area_id===null)return;const t=this.$el.querySelector("._gridOverlay"),e=t.getBoundingClientRect(),s=parseFloat(getComputedStyle(t).gap.replace("px","")),a=(e.width-s*(this.column_count-1))/this.column_count,n=(e.height-s*(this.row_count-1))/this.row_count,o=i.clientX-this.drag_start_pos.x,r=i.clientY-this.drag_start_pos.y,c=Math.round(o/(a+s)),_=Math.round(r/(n+s)),l=this.findAreaById(this.dragging_area_id),d=l.column_end-l.column_start,u=l.row_end-l.row_start;let p=this.initial_area_position.column_start+c,m=this.initial_area_position.row_start+_;p=Math.max(1,Math.min(p,Math.max(1,this.column_count-d+1))),m=Math.max(1,Math.min(m,Math.max(1,this.row_count-u+1)));const M=Math.min(p+d,this.column_count+1),P=Math.min(m+u,this.row_count+1);(p!==l.column_start||m!==l.row_start)&&(this.temp_grid_areas=this.temp_grid_areas.map(b=>b.id===this.dragging_area_id?{...b,column_start:p,column_end:M,row_start:m,row_end:P}:b))},stopDrag(){if(this.temp_grid_areas&&this.dragging_area_id){const i=this.temp_grid_areas.find(e=>e.id===this.dragging_area_id);i.column_start!==this.initial_area_position.column_start||i.column_end!==this.initial_area_position.column_end||i.row_start!==this.initial_area_position.row_start||i.row_end!==this.initial_area_position.row_end?(this.updating_area_id=this.dragging_area_id,this.updateChapter({grid_areas:this.temp_grid_areas}),setTimeout(()=>{this.temp_grid_areas=null,this.updating_area_id=null},100)):this.temp_grid_areas=null}this.dragging_area_id=null,this.drag_start_pos=null,this.initial_area_position=null,document.removeEventListener("mousemove",this.handleDrag),document.removeEventListener("mouseup",this.stopDrag)},startResize(i,t){this.resizing_area_id=i,this.resize_start_pos={x:t.clientX,y:t.clientY};const e=this.findAreaById(i);this.initial_area_position={column_end:e.column_end,row_end:e.row_end},this.temp_grid_areas=JSON.parse(JSON.stringify(this.chapter.grid_areas||[])),document.addEventListener("mousemove",this.handleResize),document.addEventListener("mouseup",this.stopResize)},handleResize(i){if(this.resizing_area_id===null)return;const t=this.$el.querySelector("._gridOverlay"),e=t.getBoundingClientRect(),s=parseFloat(getComputedStyle(t).gap.replace("px","")),a=(e.width-s*(this.column_count-1))/this.column_count,n=(e.height-s*(this.row_count-1))/this.row_count,o=i.clientX-this.resize_start_pos.x,r=i.clientY-this.resize_start_pos.y,c=Math.round(o/(a+s)),_=Math.round(r/(n+s)),l=this.findAreaById(this.resizing_area_id);let d=this.initial_area_position.column_end+c,u=this.initial_area_position.row_end+_;d=Math.max(l.column_start+1,Math.min(d,this.column_count+1)),u=Math.max(l.row_start+1,Math.min(u,this.row_count+1)),d>this.column_count+1&&(d=this.column_count+1),u>this.row_count+1&&(u=this.row_count+1),(d!==l.column_end||u!==l.row_end)&&(this.temp_grid_areas=this.temp_grid_areas.map(p=>p.id===this.resizing_area_id?{...p,column_end:d,row_end:u}:p))},stopResize(){if(this.temp_grid_areas&&this.resizing_area_id){const i=this.temp_grid_areas.find(e=>e.id===this.resizing_area_id);i.column_end!==this.initial_area_position.column_end||i.row_end!==this.initial_area_position.row_end?(this.updating_area_id=this.resizing_area_id,this.updateChapter({grid_areas:this.temp_grid_areas}),setTimeout(()=>{this.temp_grid_areas=null,this.updating_area_id=null},100)):this.temp_grid_areas=null}this.resizing_area_id=null,this.resize_start_pos=null,this.initial_area_position=null,document.removeEventListener("mousemove",this.handleResize),document.removeEventListener("mouseup",this.stopResize)},toggleChain(i){this.toggle_chain_area_id===i?this.toggle_chain_area_id=null:this.toggle_chain_area_id=i},getFirstAreaTypeInChain(i){const t=i.id.match(/^([A-Z]+)(\d*)$/);if(!t)return null;const e=t[1],s=this.grid_areas.filter(a=>{const n=a.id.match(/^([A-Z]+)(\d*)$/);return n&&n[1]===e});return s.length===0?null:(s.sort((a,n)=>{const o=a.id.match(/^([A-Z]+)(\d*)$/),r=n.id.match(/^([A-Z]+)(\d*)$/),c=o[2]?parseInt(o[2]):0,_=r[2]?parseInt(r[2]):0;return c-_}),this.getAreaMediaFileType(s[0]))},isPartOfTextChain(i){return this.getFirstAreaTypeInChain(i)==="text"},isLastOfTextChain(i){if(this.getFirstAreaTypeInChain(i)!=="text")return!1;const t=i.id.match(/^([A-Z]+)(\d*)$/);if(!t)return!1;const e=t[1],s=this.grid_areas.filter(n=>{const o=n.id.match(/^([A-Z]+)(\d*)$/);return o&&o[1]===e});return s.length<=1?!0:(s.sort((n,o)=>{const r=n.id.match(/^([A-Z]+)(\d*)$/),c=o.id.match(/^([A-Z]+)(\d*)$/),_=r[2]?parseInt(r[2]):0,l=c[2]?parseInt(c[2]):0;return _-l}),s[s.length-1].id===i.id)},getTextChains(){const i={};return this.grid_areas.forEach(t=>{if(!this.isPartOfTextChain(t))return;const e=t.id.match(/^([A-Z]+)(\d*)$/);if(!e)return;const s=e[1];i[s]||(i[s]=[]),i[s].push(t)}),Object.values(i)},getAreaPixelPosition(i){var d;const t=(d=this.$el)==null?void 0:d.querySelector("._gridOverlay");if(!t)return null;const e=t.getBoundingClientRect(),s=getComputedStyle(t).gap||"0px",a=parseFloat(s.replace("px",""))||0,n=(e.width-a*(this.column_count-1))/this.column_count,o=(e.height-a*(this.row_count-1))/this.row_count,r=(i.column_start-1)*(n+a),c=(i.row_start-1)*(o+a),_=(i.column_end-i.column_start)*n+a*(i.column_end-i.column_start-1),l=(i.row_end-i.row_start)*o+a*(i.row_end-i.row_start-1);return{x:r,y:c,width:_,height:l}},generateLinkPath(i,t){const e=this.getAreaPixelPosition(i),s=this.getAreaPixelPosition(t);if(!e||!s)return null;const a=e.x+e.width,n=e.y+e.height/2,o=s.x,r=s.y+s.height/2,c=o-a,_=Math.abs(c)*.5,l=a+_,d=n,u=o-_;return`M ${a} ${n} C ${l} ${d}, ${u} ${r}, ${o} ${r}`}},mounted(){this.$nextTick(()=>{var t;this.is_mounted=!0;const i=(t=this.$el)==null?void 0:t.querySelector("._gridOverlay");i&&window.ResizeObserver&&(this.resize_observer=new ResizeObserver(e=>{for(const s of e)this.container_size={width:s.contentRect.width,height:s.contentRect.height}}),this.resize_observer.observe(i))})},beforeDestroy(){document.removeEventListener("mousemove",this.handleResize),document.removeEventListener("mouseup",this.stopResize),document.removeEventListener("mousemove",this.handleDrag),document.removeEventListener("mouseup",this.stopDrag),this.resize_observer&&(this.resize_observer.disconnect(),this.resize_observer=null)}};var Ut=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_grid"},[e("div",{staticClass:"_gridWrapper"},[e("div",{staticClass:"_gridBackground",style:{display:"grid",gridTemplateColumns:`repeat(${t.column_count}, 1fr)`,gridTemplateRows:`repeat(${t.row_count}, 1fr)`,gap:"calc(var(--spacing) / 2)"}},t._l(t.column_count*t.row_count,function(s){return e("div",{key:"bg-"+s,staticClass:"_gridCell--background",class:{"_gridCell--occupied":t.isCellOccupied(s)},on:{click:function(a){return t.addAreaAtCell(s)}}},[t.isCellOccupied(s)?t._e():e("div",{staticClass:"_gridCell--addIcon"},[e("b-icon",{attrs:{icon:"plus",scale:"1.5"}})],1)])}),0),e("div",{staticClass:"_gridOverlay",style:{display:"grid",gridTemplateColumns:`repeat(${t.column_count||1}, 1fr)`,gridTemplateRows:`repeat(${t.row_count||1}, 1fr)`,gap:"calc(var(--spacing) / 2)"}},t._l(t.grid_areas,function(s,a){return e("GridArea",{key:s.id,attrs:{area:s,area_type:t.getAreaFileType(s),is_last_of_text_chain:t.isLastOfTextChain(s),is_being_chained:t.toggle_chain_area_id===s.id,"selected-area-id":t.selected_area_id,"dragging-area-id":t.dragging_area_id,"updating-area-id":t.updating_area_id,publication:t.publication,"column-count":t.column_count,"row-count":t.row_count},on:{select:t.selectArea,"drag-start":t.startDrag,"resize-start":t.startResize,"toggle-chain":t.toggleChain,delete:t.deleteArea}})}),1),t.text_chain_links.length>0?e("svg",{staticClass:"_linksOverlay",attrs:{xmlns:"http://www.w3.org/2000/svg"}},t._l(t.text_chain_links,function(s,a){return e("path",{key:`link-${a}`,attrs:{d:s.path,fill:"none",stroke:"var(--c-bleuvert)","stroke-width":"2","stroke-linecap":"round",opacity:"0.6"}})}),0):t._e()]),t.grid_areas.length===0?e("div",{staticClass:"_addAreaButton"},[e("p",{staticClass:"u-instructions"},[t._v(" "+t._s(t.$t("click_empty_cell_to_add_area"))+" ")])]):t._e()])},Vt=[],Zt=h(Wt,Ut,Vt,!1,null,"5a58f29a");const Xt=Zt.exports,Jt={props:{chapter:Object,publication:Object,view_mode:String},components:{GridAreas:Xt},data(){return{}},computed:{starts_on_page_options(){return this.chapter.section_type==="gallery"||this.chapter.section_type==="grid"?[{key:"page",text:this.$t("next_page")},{key:"left",text:this.$t("next_left_page")},{key:"right",text:this.$t("next_right_page")}]:[{key:"",text:this.$t("in_flow")},{key:"page",text:this.$t("next_page")},{key:"left",text:this.$t("next_left_page")},{key:"right",text:this.$t("next_right_page")}]},column_count(){return this.chapter.section_type==="grid"?this.chapter.column_count||6:this.chapter.column_count||1},row_count(){return this.chapter.row_count||6}},methods:{updateChapterMeta(i){this.$api.updateMeta({path:this.chapter.$path,new_meta:i})}}};var Yt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_chapterLayout"},[["text","gallery","grid"].includes(t.chapter.section_type)?e("fieldset",{staticClass:"u-spacingBottom _layout"},[e("legend",[t._v(t._s(t.$t("layout")))]),e("div",{staticClass:"_optionsRow"},[t.view_mode==="book"?e("div",{staticClass:"_selects--starts_on_page"},[e("DLabel",{attrs:{str:t.$t("starts_on_page")}}),e("SelectField2",{attrs:{field_name:"section_starts_on_page",value:t.chapter.section_starts_on_page||"",path:t.chapter.$path,size:"small",hide_validation:!0,can_edit:!0,options:t.starts_on_page_options}})],1):t._e(),[["text","grid"].includes(t.chapter.section_type)?e("NumberInput",{attrs:{label:t.$t("column_count"),value:t.column_count,size:"small",min:1,max:12},on:{save:function(s){return t.updateChapterMeta({column_count:s})}}}):t._e(),["grid"].includes(t.chapter.section_type)?e("NumberInput",{attrs:{label:t.$t("row_count"),value:t.row_count,size:"small",min:1,max:12},on:{save:function(s){return t.updateChapterMeta({row_count:s})}}}):t._e()]],2),t.chapter.section_type==="grid"?e("div",{staticClass:"_gridConfiguration"},[e("GridAreas",{attrs:{chapter:t.chapter,publication:t.publication}})],1):t._e()]):t._e()])},Kt=[],Qt=h(Jt,Yt,Kt,!1,null,"8b485aba");const te=Qt.exports,ee={props:{chapter:Object,chapters:Array,prev_section:Object,next_section:Object,publication:Object,chapter_position:Object,view_mode:String},components:{GalleryChapter:yt,GridChapter:Lt,ChapterLayout:te,MainText:z,SingleSection:()=>O(()=>import("./SingleSection-zTgkHDUh.js"),[])},data(){return{}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{},methods:{}};var ie=function(){var s;var t=this,e=t._self._c;return e("div",{staticClass:"_openChapter"},[e("div",{staticClass:"_navBtns"},[e("div",{staticClass:"_navBtns--content"},[e("div",{},[e("button",{staticClass:"u-linkList",attrs:{type:"button"},on:{click:function(a){return t.$emit("close")}}},[e("b-icon",{attrs:{icon:"x",label:t.$t("close")}}),t._v(" "+t._s(t.$t("close"))+" ")],1)]),e("div",{directives:[{name:"show",rawName:"v-show",value:t.next_section||t.prev_section,expression:"next_section || prev_section"}],staticClass:"_navBtns--content--buttons"},[e("span",[t.prev_section?e("button",{staticClass:"u-linkList",attrs:{type:"button"},on:{click:function(a){return t.$emit("prev")}}},[e("b-icon",{attrs:{icon:"arrow-left-short"}}),e("span",[t._v(" "+t._s(t.prev_section.section_title)+" ")])],1):e("span",[t._v("–")])]),e("span",{staticClass:"_separator"},[t._v("|")]),e("span",[t.next_section?e("button",{staticClass:"u-linkList",attrs:{type:"button"},on:{click:function(a){return t.$emit("next")}}},[e("span",[t._v(" "+t._s(t.next_section.section_title)+" ")]),e("b-icon",{attrs:{icon:"arrow-right-short"}})],1):e("span",[t._v("–")])])]),e("div")])]),e("div",{staticClass:"_openChapter--content"},[e("div",{staticClass:"_topButtons"},[e("TitleField",{attrs:{field_name:"section_title",content:t.chapter.section_title,maxlength:100,tag:"h1",path:t.chapter.$path,can_edit:!0}}),e("DropDown",{attrs:{right:!0,show_label:!1}},[e("RemoveMenu",{on:{remove:function(a){return t.$emit("remove")}}})],1)],1),e("div",{staticClass:"_infos"},[e("div",{staticClass:"_content--type"},[t.chapter.section_type==="text"?[e("b-icon",{attrs:{icon:"markdown"}}),t._v(" "+t._s(t.$t("text"))+" ")]:t.chapter.section_type==="gallery"?[e("b-icon",{attrs:{icon:"image"}}),t._v(" "+t._s(t.$t("gallery"))+" ")]:t.chapter.section_type==="grid"?[e("b-icon",{attrs:{icon:"grid-fill"}}),t._v(" "+t._s(t.$t("grid"))+" ")]:t.chapter.section_type==="story"?[e("b-icon",{attrs:{icon:"list"}}),t._v(" "+t._s(t.$t("story"))+" ")]:t._e()],2),e("transition",{attrs:{name:"fade",mode:"out-in"}},[t.view_mode==="book"&&((s=t.chapter_position)!=null&&s.first_page)?e("div",[e("div",{key:t.chapter_position.first_page,staticClass:"_selects--pageRange"},[t._v(" p."+t._s(t.chapter_position.first_page)+" "),t.chapter_position.first_page!==t.chapter_position.last_page?[e("b-icon",{attrs:{icon:"arrow-right-short"}}),t._v(" p."+t._s(t.chapter_position.last_page)+" ")]:t._e()],2)]):t._e()])],1),e("ChapterLayout",{attrs:{chapter:t.chapter,publication:t.publication,view_mode:t.view_mode}}),e("div",{staticClass:"_content"},[t.chapter.section_type==="text"?[t.chapter._main_text?e("MainText",{attrs:{text_file:t.chapter._main_text,medias_holder:t.chapter,publication_path:t.publication.$path}}):e("div",{staticClass:"u-instructions"},[t._v(" "+t._s(t.$t("no_content"))+" ")])]:t._e(),t.chapter.section_type==="gallery"?[e("GalleryChapter",{attrs:{chapter:t.chapter,publication:t.publication}})]:t._e(),t.chapter.section_type==="grid"?[e("GridChapter",{attrs:{chapter:t.chapter,publication:t.publication}})]:t._e(),t.chapter.section_type==="story"?[e("SingleSection",{staticClass:"_singleSection",attrs:{publication:t.publication,section:t.chapter,can_edit:!0}})]:t._e()],2)],1)])},se=[],ae=h(ee,ie,se,!1,null,"7986247a");const ne=ae.exports,oe={props:{style_file:Object,default_styles:String,show_source_html:Boolean},components:{},data(){return{show_reset_modal:!1,show_remove_modal:!1}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{pretty_default_styles(){return x.highlight(this.default_styles,{language:"css"}).value}},methods:{async resetCustom(){this.$refs.styleEditor.restoreVersion(this.default_styles),this.show_reset_modal=!1}}};var re=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_openedStyleFile"},[t.style_file.$path==="default"?[e("h2",[t._v(t._s(t.$t("default_styles")))])]:[e("TitleField",{attrs:{label:t.$t("name"),show_label:!1,field_name:"css_title",tag:"h2",content:t.style_file.css_title,path:t.style_file.$path,maxlength:40,can_edit:!0}})],e("div",{staticClass:"u-spacingBottom"}),e("div",{staticClass:"_topBtns"},[e("ToggleInput",{attrs:{content:t.show_source_html,label:t.$t("show_source_html")},on:{"update:content":function(s){return t.$emit("update:show_source_html",s)}}}),t.style_file.$path!=="default"?[e("button",{key:"resetCustom",staticClass:"u-buttonLink u-buttonLink_red",attrs:{type:"button"},on:{click:function(s){t.show_reset_modal=!0}}},[t._v(" "+t._s(t.$t("back_to_default_styles"))+" ")]),t.show_reset_modal?e("BaseModal2",{attrs:{title:t.$t("back_to_default_styles")},on:{close:function(s){t.show_reset_modal=!1},save:t.resetCustom}},[e("div",{staticClass:"defaultCode"},[e("pre",{domProps:{innerHTML:t._s(t.pretty_default_styles)}})]),e("template",{slot:"footer"},[e("SaveCancelButtons",{attrs:{cancel_text:t.$t("cancel"),save_text:t.$t("reset")},on:{save:t.resetCustom,cancel:function(s){t.show_reset_modal=!1}}})],1)],2):t._e(),e("button",{staticClass:"u-buttonLink u-buttonLink_red",attrs:{type:"button"},on:{click:function(s){t.show_remove_modal=!0}}},[e("b-icon",{attrs:{icon:"trash"}}),t._v(" "+t._s(t.$t("remove"))+" ")],1),t.show_remove_modal?e("RemoveMenu2",{attrs:{modal_title:t.$t("remove_css_file",{name:t.style_file.css_title}),path:t.style_file.$path},on:{removedSuccessfully:function(s){return t.$emit("close")},close:function(s){t.show_remove_modal=!1}}}):t._e()]:t._e()],2),t.style_file.$path!=="default"?e("CollaborativeEditor3",{key:t.style_file.$path,ref:"styleEditor",attrs:{content:t.style_file.$content,path:t.style_file.$path,custom_formats:[],save_format:"raw",mode:"always_active",can_edit:!0}}):e("div",{staticClass:"defaultCode"},[e("pre",{domProps:{innerHTML:t._s(t.pretty_default_styles)}})]),e("div",{staticClass:"u-spacingBottom"})],2)},ce=[],_e=h(oe,re,ce,!1,null,"e0c28339");const le=_e.exports,de={props:{publication:Object,opened_style_file_meta:String,show_source_html:Boolean},components:{OpenedGraphicStyles:le},data(){return{default_styles:f,show_create_css_modal:!1,new_css_title:""}},created(){},mounted(){},beforeDestroy(){this.$emit("update:show_source_html",!1)},watch:{},computed:{pretty_default_styles(){return x.highlight(this.default_styles,{language:"css"}).value},style_files(){var i;return(i=this.publication.$files)==null?void 0:i.filter(t=>t.is_css_styles===!0).sort((t,e)=>{const s=t.css_title||this.getFilename(t.$path),a=e.css_title||this.getFilename(e.$path);if(s<a)return-1;if(s>a)return 1})},opened_style_file(){return this.opened_style_file_meta==="default"||this.style_files.length===0?{$path:"default",css_title:this.$t("default_styles"),$content:f,is_default:!0}:this.style_files.find(i=>this.getFilename(i.$path)===this.opened_style_file_meta)}},methods:{async createCustomStylesheet(){const i=this.new_css_title+".css",{meta_filename:t}=await this.$api.uploadText({path:this.publication.$path,filename:i,content:f,additional_meta:{$type:"text",css_title:this.new_css_title,is_css_styles:!0}});this.new_css_title="",this.show_create_css_modal=!1,this.$emit("setStyleFile",t)},async resetCustom(){this.$refs.styleEditor.restoreVersion(f)},openStyleFile(i){this.$emit("setStyleFile",this.getFilename(i))},openDefaultStyles(){this.$emit("setStyleFile","default")}}};var ue=function(){var s;var t=this,e=t._self._c;return e("div",{staticClass:"_editGraphicStyles"},[e("div",{staticClass:"_close_button"},[e("button",{staticClass:"u-button u-button_icon",attrs:{type:"button"},on:{click:function(a){return t.$emit("close")}}},[e("b-icon",{attrs:{icon:"x-lg",label:t.$t("close")}})],1)]),e("div",{staticClass:"_topTabs"},[t._l(t.style_files,function(a){var n;return e("button",{key:a.$path,staticClass:"u-button u-button_small",class:{"is--active":((n=t.opened_style_file)==null?void 0:n.$path)===a.$path},attrs:{type:"button"},on:{click:function(o){return t.openStyleFile(a.$path)}}},[t._v(" "+t._s(a.css_title||t.getFilename(a.$path))+" ")])}),e("button",{staticClass:"u-button u-button_small",class:{"is--active":((s=t.opened_style_file)==null?void 0:s.$path)==="default"},attrs:{type:"button"},on:{click:t.openDefaultStyles}},[t._v(" "+t._s(t.$t("default_styles"))+" ")]),e("button",{staticClass:"u-button u-button_small u-button_bleumarine",attrs:{type:"button"},on:{click:function(a){t.show_create_css_modal=!0}}},[t._v(" "+t._s(t.$t("create_custom_stylesheet"))+" ")]),t.show_create_css_modal?e("BaseModal2",{attrs:{title:t.$t("create_custom_stylesheet")},on:{close:function(a){t.show_create_css_modal=!1},save:t.createCustomStylesheet},scopedSlots:t._u([{key:"footer",fn:function(){return[e("div"),e("button",{staticClass:"u-button u-button_bleuvert",attrs:{type:"button"},on:{click:t.createCustomStylesheet}},[e("b-icon",{attrs:{icon:"plus-circle"}}),t._v(" "+t._s(t.$t("create_and_open"))+" ")],1)]},proxy:!0}],null,!1,4091224930)},[e("DLabel",{attrs:{str:t.$t("name")}}),e("TextInput",{ref:"titleInput",attrs:{content:t.new_css_title,maxlength:40,required:!0,autofocus:!0},on:{"update:content":function(a){t.new_css_title=a},toggleValidity:a=>t.allow_save=a,onEnter:t.createCustomStylesheet}})],1):t._e()],2),e("div",{staticClass:"_openedStyleFile"},[e("transition",{attrs:{name:"fade",mode:"out-in"}},[t.opened_style_file?e("OpenedGraphicStyles",{key:t.opened_style_file.$path,attrs:{style_file:t.opened_style_file,default_styles:t.default_styles,show_source_html:t.show_source_html},on:{"update:show_source_html":function(a){return t.$emit("update:show_source_html",a)},close:t.openDefaultStyles}}):t._e()],1)],1)])},he=[],pe=h(de,ue,he,!1,null,"d0fbc594");const me=pe.exports,fe={props:{publication:Object,force_layout_mode:String},components:{},data(){return{edit_mode:!1,is_saving:!1,can_edit:!0,new_layout_mode:void 0,new_page_width:void 0,new_page_height:void 0}},created(){},mounted(){this.initValues()},beforeDestroy(){},watch:{new_layout_mode(){const{width:i,height:t}=this.format_options[0];this.new_page_width||(this.new_page_width=i),this.new_page_height||(this.new_page_height=t)}},computed:{format_options(){return this.new_layout_mode==="print"?[{key:"A4_portrait",text:this.$t("A4_portrait"),width:210,height:297},{key:"A4_landscape",text:this.$t("A4_landscape"),width:297,height:210},{key:"A5_portrait",text:this.$t("A5_portrait"),width:148,height:210},{key:"A5_landscape",text:this.$t("A5_landscape"),width:210,height:148},{key:"custom",text:this.$t("custom")}]:[{key:"recommended",text:this.$t("recommended"),width:960,height:700},{key:"desktop1080",text:this.$t("desktop_1080"),width:1920,height:1080},{key:"desktop720",text:this.$t("desktop_720"),width:1280,height:720},{key:"custom",text:this.$t("custom")}]},predefined_format_from_width(){const i=this.format_options.find(t=>t.width===this.new_page_width&&t.height===this.new_page_height);return i?i.key:"custom"},unit(){return this.new_layout_mode==="screen"?"px":"mm"}},methods:{initValues(){this.force_layout_mode?this.new_layout_mode=this.force_layout_mode:this.new_layout_mode=this.publication.layout_mode||"print",this.new_page_width=this.publication.page_width||210,this.new_page_height=this.publication.page_height||297},enableEditMode(){this.edit_mode=!0},setSizeFromFormat(i){const t=i.target.value;if(t==="custom")return;const e=this.format_options.find(s=>s.key===t);this.new_page_width=e.width,this.new_page_height=e.height},cancel(){this.edit_mode=!1,this.is_saving=!1,this.initValues()},async updateSize(){this.is_saving=!0;try{const i={layout_mode:this.new_layout_mode,page_width:this.new_page_width,page_height:this.new_page_height};await this.$api.updateMeta({path:this.publication.$path,new_meta:i}),this.edit_mode=!1,this.is_saving=!1}catch(i){this.is_saving=!1,this.edit_mode=!1,this.$alertify.closeLogOnClick(!0).delay(4e3).error(this.$t("couldntbesaved")),this.$alertify.closeLogOnClick(!0).error(i.response.data)}}}};var ge=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_widthHeightField"},[e("fieldset",[e("legend",[t._v(t._s(t.$t("format")))]),t.can_edit&&!t.edit_mode?e("EditBtn",{attrs:{is_unfolded:!0},on:{click:t.enableEditMode}}):t._e(),e("br"),e("br"),t.force_layout_mode?t._e():[e("DLabel",{staticClass:"_label",attrs:{str:t.$t("document_type"),tag:"H3"}}),t._l([{key:"print",label:t.$t("print"),instructions:t.$t("print_instr")},{key:"screen",label:t.$t("screen"),instructions:t.$t("screen_instr")}],function(s){return e("div",{key:s.key},[e("div",[e("input",{directives:[{name:"model",rawName:"v-model",value:t.new_layout_mode,expression:"new_layout_mode"}],attrs:{type:"radio",name:s.key,id:"radioi-lmode-"+s.key,disabled:!t.edit_mode},domProps:{value:s.key,checked:t._q(t.new_layout_mode,s.key)},on:{change:function(a){t.new_layout_mode=s.key}}}),e("label",{attrs:{for:"radioi-lmode-"+s.key}},[t._v(" "+t._s(s.label)),e("br"),e("small",{domProps:{innerHTML:t._s(s.instructions)}})])])])})],e("br"),e("transition",{attrs:{name:"fade",mode:"out-in"}},[e("div",{key:t.new_layout_mode},[e("DLabel",{staticClass:"_label",attrs:{str:t.$t("format"),tag:"h3",instructions:t.$t("format_instructions")}}),[e("select",{attrs:{disabled:!t.edit_mode},domProps:{value:t.predefined_format_from_width},on:{change:t.setSizeFromFormat}},t._l(t.format_options,function(s){return e("option",{key:s.key,domProps:{value:s.key,textContent:t._s(s.text)}})}),0)],e("div",{staticClass:"u-sameRow"},[e("div",{},[e("DLabel",{attrs:{str:t.$t("width")}}),e("div",{staticClass:"u-inputGroup"},[e("input",{directives:[{name:"model",rawName:"v-model.number",value:t.new_page_width,expression:"new_page_width",modifiers:{number:!0}}],attrs:{type:"number",disabled:!t.edit_mode},domProps:{value:t.new_page_width},on:{input:function(s){s.target.composing||(t.new_page_width=t._n(s.target.value))},blur:function(s){return t.$forceUpdate()}}}),e("span",{staticClass:"u-suffix",domProps:{textContent:t._s(t.unit)}})])],1),e("div",{},[e("DLabel",{attrs:{str:t.$t("height")}}),e("div",{staticClass:"u-inputGroup"},[e("input",{directives:[{name:"model",rawName:"v-model.number",value:t.new_page_height,expression:"new_page_height",modifiers:{number:!0}}],attrs:{type:"number",disabled:!t.edit_mode},domProps:{value:t.new_page_height},on:{input:function(s){s.target.composing||(t.new_page_height=t._n(s.target.value))},blur:function(s){return t.$forceUpdate()}}}),e("span",{staticClass:"u-suffix",domProps:{textContent:t._s(t.unit)}})])],1)])],2)]),t.edit_mode?e("div",{staticClass:"_footer"},[e("SaveCancelButtons",{staticClass:"_scb",attrs:{is_saving:t.is_saving},on:{save:t.updateSize,cancel:t.cancel}})],1):t._e()],2)])},ve=[],be=h(fe,ge,ve,!1,null,"5096eb70");const ye=be.exports,we={props:{publication:Object,pane_infos:Object,can_edit:Boolean},components:{Splitpanes:Z,Pane:tt,ChaptersSummary:mt,OpenChapter:ne,ViewContent:B,GraphicStyles:me,PublicationSettings:R,WidthHeightField:ye},provide(){return{$getMetaFilenamesAlreadyPresent:()=>this.meta_filenames_already_present}},data(){return{show_edit_pane:!0,show_preview_pane:!0,show_source_html:!1,chapters_positions:{}}},created(){},mounted(){},beforeDestroy(){this.$emit("updatePane",{key:"chapter",value:!1})},watch:{},computed:{view_mode(){var i;return((i=this.$route.query)==null?void 0:i.view_mode)||"book"},all_chapters(){return this.getSectionsWithProps({publication:this.publication,group:"sections_list"}).map(i=>(i.main_text_meta&&(i._main_text=this.publication.$files.find(t=>t.$path.endsWith("/"+i.main_text_meta))),i.section_type||(i.section_type="text"),i))},opened_section_meta_filename(){return this.pane_infos.chapter},opened_chapter(){return this.opened_section_meta_filename?this.all_chapters.find(i=>i.$path.endsWith(this.opened_section_meta_filename)):!1},prev_section(){if(!this.opened_chapter)return!1;const i=this.all_chapters.findIndex(t=>t.$path.endsWith(this.opened_section_meta_filename));return this.all_chapters[i-1]},next_section(){if(!this.opened_chapter)return!1;const i=this.all_chapters.findIndex(t=>t.$path.endsWith(this.opened_section_meta_filename));return this.all_chapters[i+1]},show_graphic_styles(){var i;return((i=this.pane_infos)==null?void 0:i.edit_graphics)==="true"},opened_style_file_meta(){var i;return((i=this.pane_infos)==null?void 0:i.style)||"first"},meta_filenames_already_present(){let i=[],t=[];return this.all_chapters.forEach(e=>{Array.isArray(e.source_medias)&&e.source_medias.forEach(s=>{this.getFilename(e.$path)===this.opened_section_meta_filename?i.push(s.meta_filename_in_project):t.push(s.meta_filename_in_project)})}),[{label:this.$t("in_this_section"),medias:i,color:"var(--c-orange)"},{label:this.$t("in_another_section"),medias:t,color:"var(--c-bleuvert)"}]}},methods:{openChapter(i){const e=this.all_chapters.findIndex(s=>s.$path.endsWith(this.opened_section_meta_filename))+i;if(e>=0&&e<=this.all_chapters.length-1){const s=this.getFilename(this.all_chapters[e].$path);this.$emit("updatePane",{key:"chapter",value:s})}},async removeChapter(i){i._main_text&&await this.$api.deleteItem({path:i._main_text.$path}),await this.$api.deleteItem({path:i.$path})},getChapterPosition(i){const t=this.getFilename(i);return this.chapters_positions[t]},openGraphicStyles(){this.$emit("updatePane",{key:"edit_graphics",value:!0})}}};var $e=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_editionTemplate"},[t.can_edit?e("splitpanes",{staticClass:"_splitpanes"},[t.show_edit_pane?e("pane",[e("div",{staticClass:"_chapterSummary"},[e("div",{staticClass:"_chapterSummary--content"},[e("div",{staticClass:"_showPreviewBtn"},[e("ToggleInput",{attrs:{content:t.show_preview_pane,label:t.$t("show_preview")+" ➵"},on:{"update:content":function(s){t.show_preview_pane=s}}})],1),e("ChaptersSummary",{attrs:{publication:t.publication,sections:t.all_chapters,opened_section_meta_filename:t.opened_section_meta_filename,view_mode:t.view_mode,chapters_positions:t.chapters_positions},on:{toggleSection:function(s){return t.$emit("updatePane",{key:"chapter",value:s})}}})],1)]),t._e(),e("transition",{attrs:{name:"pagechange",mode:"in-out"}},[t.show_graphic_styles?e("GraphicStyles",{key:"edit_graphics",attrs:{publication:t.publication,opened_style_file_meta:t.opened_style_file_meta,show_source_html:t.show_source_html},on:{"update:show_source_html":function(s){t.show_source_html=s},close:function(s){return t.$emit("updatePane",{key:"edit_graphics",value:!1})},setStyleFile:function(s){return t.$emit("updatePane",{key:"style",value:s})}}}):t.opened_chapter?e("OpenChapter",{key:t.opened_chapter.$path,attrs:{chapter:t.opened_chapter,chapters:t.all_chapters,prev_section:t.prev_section,next_section:t.next_section,publication:t.publication,chapter_position:t.getChapterPosition(t.opened_chapter.$path),view_mode:t.view_mode},on:{remove:function(s){return t.removeChapter(t.opened_chapter)},close:function(s){return t.$emit("updatePane",{key:"chapter",value:!1})},prev:function(s){return t.openChapter(-1)},next:function(s){return t.openChapter(1)}}}):t._e()],1)],1):t._e(),t.show_preview_pane?e("pane",[e("div",{staticClass:"_viewer"},[e("ViewContent",{attrs:{publication:t.publication,opened_chapter_meta_filename:t.opened_section_meta_filename,view_mode:t.view_mode,opened_style_file_meta:t.opened_style_file_meta,show_source_html:t.show_source_html,show_source_html_toggle:t.can_edit&&t.view_mode==="book",can_edit:t.can_edit},on:{"update:show_source_html":function(s){t.show_source_html=s},openChapter:function(s){return t.$emit("updatePane",{key:"chapter",value:s})},changeView:function(s){return t.$emit("updatePane",{key:"view_mode",value:s})},setStyleFile:function(s){return t.$emit("updatePane",{key:"style",value:s})},updateChaptersPositions:function(s){t.chapters_positions=s}}})],1)]):t._e()],1):t._e(),t.can_edit?e("PublicationSettings",[e("WidthHeightField",{attrs:{publication:t.publication,force_layout_mode:"print"}})],1):e("div",{staticClass:"_previewMode"},[e("ViewContent",{attrs:{publication:t.publication,opened_chapter_meta_filename:t.opened_section_meta_filename,view_mode:t.view_mode,opened_style_file_meta:t.opened_style_file_meta,viewer_type:"div",can_edit:!1},on:{openChapter:function(s){return t.$emit("updatePane",{key:"chapter",value:s})},changeView:function(s){return t.$emit("updatePane",{key:"view_mode",value:s})},setStyleFile:function(s){return t.$emit("updatePane",{key:"style",value:s})}}})],1)],1)},xe=[],Ce=h(we,$e,xe,!1,null,"c59a6268");const De=Ce.exports;export{De as default};
